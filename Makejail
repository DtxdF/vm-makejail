ARG is_public_vm=0
ARG exclude_ports?
ARG with_qemu_tools=0
ARG pf_stricter=1

OPTION start
OPTION overwrite=force
OPTION virtualnet=:<random> default
OPTION nat
OPTION mount_devfs
OPTION device=include \$devfsrules_hide_all
OPTION device=include \$devfsrules_unhide_basic
OPTION device=include \$devfsrules_unhide_login
OPTION device=path pf unhide
OPTION device=path vmm unhide
OPTION device=path 'vmm/*' unhide
OPTION device=path vmm.io unhide
OPTION device=path 'vmm.io/*' unhide
OPTION device=path vmmctl unhide
OPTION device=path 'nmdm*' unhide
OPTION device=path 'tap*' unhide
OPTION device=path mem unhide
OPTION device=path kmem unhide
OPTION device=path pci unhide
OPTION device=path io unhide
OPTION template=template.conf
OPTION volume=vm-data mountpoint:/vm
OPTION type=thick

RAW default_interface=`appjail cmd jexec "${APPJAIL_JAILNAME}" route -n4 get default 2> /dev/null | grep 'interface:' | cut -d' ' -f4-`

RAW if [ -z "${default_interface}" ]; then
        RAW echo "No default interface found. Cannot continue ..."
        RAW exit 1
RAW fi

VAR --make-arg-env DEFAULT_INTERFACE=${default_interface}
VAR --make-arg-env JAIL_NAME=${APPJAIL_JAILNAME}

# If the virtual machine refuses to shut down when the jail is stopped, it remains,
# so vm-bhyve cannot start that virtual machine on the next run.
RAW if [ -c "/dev/vmm/${APPJAIL_JAILNAME}" ]; then
        CMD --local bhyvectl "--vm=${APPJAIL_JAILNAME}" --destroy
RAW fi

CMD mkdir -p /usr/local/etc/pkg/repos
RAW if appjail cmd jexec "${APPJAIL_JAILNAME}" [ "`freebsd-version -u | grep -oEe '^[^.]+'`" -ge 15 ]; then
        COPY pkg/post-pkgbase.conf /usr/local/etc/pkg/repos/PKG.conf
        PKG FreeBSD-acpi
RAW else
        COPY pkg/pre-pkgbase.conf /usr/local/etc/pkg/repos/PKG.conf
RAW fi

PKG vm-bhyve-devel bhyve-firmware tmux

RAW if [ "${with_qemu_tools}" != 0 ]; then
        PKG qemu-tools
RAW fi

SYSRC vm_enable=YES
SYSRC vm_dir=/vm

RAW if appjail cmd local "${APPJAIL_JAILNAME}" [ ! -f vm/.done ]; then
        CMD mkdir -p /vm && \
            find /vm -depth 1 -not -name '.img' -and -not -name '.iso' -exec rm -rf {} + && \
            vm init && \
            cp /usr/local/share/examples/vm-bhyve/*.conf /vm/.templates && \
            sysrc -f /vm/.config/system.conf console=tmux
RAW fi

CMD echo "nat on ${DEFAULT_INTERFACE} from {192.168.8.0/24} to any -> (${DEFAULT_INTERFACE})" > /etc/pf.conf
RAW if [ -n "${exclude_ports}" ]; then
        CMD echo "no rdr on ${DEFAULT_INTERFACE} inet proto { tcp, udp } from any to (${DEFAULT_INTERFACE}:0) port ${exclude_ports}" >> /etc/pf.conf
RAW fi
RAW if [ "${is_public_vm}" != 0 ]; then
        CMD echo "rdr pass on ${DEFAULT_INTERFACE} inet proto { tcp, udp } from any to (${DEFAULT_INTERFACE}:0) port 1:65535 -> 192.168.8.2 port 1:65535" >> /etc/pf.conf
RAW fi
RAW if [ "${pf_stricter}" != 0 ]; then
        CMD echo "block in on vmbridge from ! 192.168.8.0/24" >> /etc/pf.conf
        CMD echo "block in on vmbridge from 192.168.8.0/24 to (vmbridge:0)" >> /etc/pf.conf
RAW fi
CMD echo net.inet.ip.forwarding=1 >> /etc/sysctl.conf

CMD sysctl net.inet.ip.forwarding=1
SERVICE pf oneenable
SERVICE pf start

SYSRC "cloned_interfaces+=bridge0"
SYSRC ifconfig_bridge0_name=vmbridge
SYSRC "ifconfig_vmbridge=inet 192.168.8.1/24"

CMD service netif cloneup bridge0 && \
    service netif start bridge0 && \
    service netif start vmbridge

RAW if appjail cmd local "${APPJAIL_JAILNAME}" [ ! -f vm/.done ]; then
        CMD vm switch create -t manual -b vmbridge public
RAW fi

SYSRC syslogd_flags=-ss
SERVICE syslogd restart

STAGE create

# This stage is not executed when the jail is created, unless we use the `STOP`
# instruction at the end of the `build` stage, but this is not necessary, as
# we already perform the following test at the beginning of the `build` stage.
# The following test is more useful before the jail and, therefore, the VM is
# started.
RAW if [ -c "/dev/vmm/${APPJAIL_JAILNAME}" ]; then
        CMD --local bhyvectl "--vm=${APPJAIL_JAILNAME}" --destroy
RAW fi

STAGE stop

CMD rm -f /vm/*/run.lock
